min_version = "2024.9.5"

[settings]
experimental = true
idiomatic_version_file_enable_tools = ["node"]

[env]
_.file = '.env'

[hooks]
enter = "mise i -q && npm i"

[tools]
actionlint = "1.7.9"
ffmpeg = "8.0.1"
jq = "1.8.1"
markdownlint-cli2 = "0.17.2"
pipx = "latest"
"pipx:check-jsonschema" = "0.36.0"
shellcheck = "0.11.0"
trivy = "0.68.1"
vhs = "0.10.0"
yamllint = "1.37.1" # Created with `mise use --pin yamllint`

[tasks.yamllint]
description = "Running yamllint locally on all yaml files"
run = "yamllint -c ./.yamllintrc ."
hide = true

[tasks.trivy-fs]
description = "Running trivy against local files"
run = "trivy fs --ignorefile .trivyignore ."
hide = true

[tasks.actionlint]
description = "Running actionlint against GitHub Actions workflows"
run = "actionlint"
hide = true

[tasks.markdownlint]
description = "Running markdownlint against markdown files"
run = "markdownlint-cli2 '**/*.md' '#node_modules' '#terraform/.terraform' '#.venv' '#venv'"
hide = true

[tasks.shellcheck]
description = "Running shellcheck against shell scripts"
run = "[ -n \"$(ls -A *.sh 2>/dev/null)\" ] && shellcheck *.sh || echo 'No shell scripts found, skipping shellcheck'"
hide = true

[tasks.check-issue-forms]
description = "Validating GitHub issue form templates against JSON schema"
run = "check-jsonschema --schemafile https://json.schemastore.org/github-issue-forms.json .github/ISSUE_TEMPLATE/*.yml"
hide = true

[tasks.format-check]
description = "Checking code formatting + static analysis"
hide = true
run = "npm run lint"

[tasks.lint]
description = "Run all required linting tools (in parallel)"
run = [
    { tasks = ['actionlint', 'yamllint', 'markdownlint', 'shellcheck', 'check-issue-forms', 'format-check']}, # These run in parallel!
    { task = 'trivy-fs'}
]

[tasks.test]
description = "Run unit tests in this project"
run = "npm test"

[tasks.ci] # only dependencies to be run
description = 'Run CI tasks'
run = [
    { task = 'lint'},
    { task = 'test'}
]

[tasks.format-fix]
description = "Fixing format issues"
hide = true
run = [
    "npm run lint:fix"
]

[tasks.demo]
description = "Record a demo of lousy-agents using VHS"
run = [
    "npm run build",
    "npm link",
    "rm -rf demo",
    "mkdir -p media",
    "vhs demo.tape",
    "rm -rf demo"
]
